# 高可用架构设计
## 如何设计一个高可用系统架构？
高可用架构设计是一个系统性的工程，其核心目标是确保系统在出现各类故障时，依然能够持续对外提供服务，最大限度地减少停机时间，通常用几个9（如99.99%）来衡量。
其核心指导思想可以概括为：“冗余 + 自动故障转移”。
### 具体方案
- 设施部署冗余与容灾：多机房部署，异地容灾。
- 服务冗余：任何服务都应部署多个实例，避免单点故障。
- 数据冗余：数据库主从复制。
- 故障转移：集群中leader节点发生故障时，支持自动主从切换的能力。
- 弹性伸缩：根据监控指标（CPU、QPS等）自动增加或减少实例数量，以应对流量波动。
- 服务治理与容错：服务熔断，降级，服务限流，超时重试。
- 异步化：通过消息队列解耦服务。生产者快速响应用户，消费者异步处理任务，提升系统吞吐量和抗冲击能力。

## 服务熔断和降级
### 服务降级，熔断的概念
#### 服务降级
请求量超过系统可以容纳的数量，就要做服务降级  
将不重要的服务停掉，这些请求进行快速失败返回，保证资源最大化供给重要服务的功能。
#### 服务熔断
服务熔断是在下游服务出现故障时，快速切断故障传播，保障自身正常运行。  
服务A有一个方法要调用B的接口，当B出问题了，接口超时，那么A会有很多请求被阻塞，导致A的资源被耗光，进而导致A的其他功能也不可用了。  
解决这种情况的方法，就是将A调用B的这个接口进行熔断，释放A请求B的资源，先让A的其他功能可以正常使用。  
一般服务熔断我们不会直接将所有A到B的流量切断，而是先切断50%观察一下，如果继续出现异常，就切断80%。当B恢复正常后，也是慢慢增加访问B的流量，直到恢复100%  
### 服务熔断和降级方案
1. 客户端层：客户端通过熔断组件Sentinel在发起远程调用前检查熔断状态，如果熔断就直接返回失败，不再发起调用。
2. 网关层：在api网关比如Spring Cloud Gateway，Nginx进行处理。在网关转发请求前，根据预设规则拦截请求并直接返回。
3. 服务端层：在服务端处理请求时，通过AOP或filter检测服务自身状态，触发熔断降级。
## 系统限流
#### 1.滑动窗口计数法
  定义一个固定时长的窗口，内部按照时间平均划分多个小区间，比如每秒一个小区间，那么每秒处理一个小区间的请求。
  统计窗口内的请求总数，如果超过阈值，就抛弃新的请求，从而控制流量。
#### 2.漏桶法
  入口不限速，出口恒定速率，桶满后请求被丢弃。  
  平滑输出，无法快速消化突发流量。
#### 3.令牌桶法
  固定速率往桶里放令牌，请求从桶中取令牌，桶满了停止往里放令牌。
  当桶内令牌充足时，可以应对突发流量。
