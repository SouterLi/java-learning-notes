# ElasticSearch
## ElasticSearch的优点
1. ES具有强大的全文检索能力  
2. 近实时搜索 - 每秒刷新  
3. 分布式架构 - 自动分片，副本机制，无缝扩展  
4. 高性能聚合分析 - 替代复杂sql  
5. 丰富的查询功能  
6. 生态完善 - Logstash轻松接入日志，Kibana提供图表展示， X-Pack监控集群健康状态  

## ElasticSearch的查询流程
1. 搜索请求阶段
客户端请求：向协调节点发送搜索请求。  
协调节点角色：不存储数据，只负责请求路由、分片查询分发和结果聚合。
2. 查询阶段（Query Phase）  
a) 分片选择：协调节点根据索引的分片分布情况，确定需要查询的主分片和 副本分片，默认轮询选择副本以负载均衡。  
b) 分发子查询：协调节点向所有相关分片（主或副本）广播查询请求。每个分片 独立执行查询，但仅返回匹配文档的元数据，而非完整文档。  
c) 分片本地查询流程  
1.解析查询：根据查询类型（如 match、term、bool）生成 Lucene 查询。  
2.检索倒排索引：定位包含关键词的文档 ID。  
3.相关性打分：使用 TF-IDF/BM25 算法计算文档得分。  
4.过滤与排序：应用过滤器（如 range）和排序规则（如按 _score 降序）。  
5.结果裁剪：根据 from + size 参数返回当前分片的 Top-N 结果。  
d) 结果合并：协调节点收集所有分片的返回结果，按 _score 或其他排序字段 全局排序，生成最终 Top-N 文档 ID 列表。  
3. 取回阶段（Fetch Phase）  
a) 获取完整文档：协调节点根据全局排序后的文档 ID 列表，向对应分片发送 multi_get 请求，获取完整文档内容（_source 字段），分片返回原始文档数据。  
b) 高亮与聚合计算（可选）  
c) 返回最终结果：协调节点将完整结果组装为 JSON 格式，返回给客户端。  

## 数据写入流程
1.客户端向协调节点发起写入请求，协调节点请求路由  
2.路由计算和分片定位  
3.写入主分片 ，写入内存缓冲区，此时不可读 ，每一秒，内存缓冲区的数据会生成一个新的段，存储在文件系统缓存，然后清空内存缓冲区，此时可读  
4.同步数据到副本分片 ，主分片将写入操作并行转发给所有副本分片，副本分片写入数据的流程和主分片一致。  
5.定期刷盘 ，默认每30min或Translog到达512m时，会将文件系统缓存中的段持久化到磁盘，并生成新的Translog  
6.后台定期合并小段为大段，合并时会物理删除标记为.del的文档

## 如何优化Elasticsearch查询性能
### 1.索引优化  
- 设置合理的分片个数，每个分片30-50G，10个分片  
- 对于不需要分词的字段（如ID、分类、标签）使用 keyword 类型，需要分词的字段（如文本内容）使用 text 类型  
- 禁用不需要的字段  
- 使用索引模板统一配置索引设置（如分片、映射）  
### 2.查询优化  
- 避免全量查询，限制返回字段个数  
- 使用Filter代替Query  
- 不要使用wildcard，使用ngram分词  
- 使用bool组合多个must/should查询，避免多次查询  
- 避免使用通配符*查询，会导致全表扫描  
### 3.集群和硬件优化  
- 使用data节点查询数据  
- 冷热数据分离  
- 启用缓存  