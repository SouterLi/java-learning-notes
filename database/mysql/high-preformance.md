# 高性能查询
## 分库分表
1.水平分表
将一张大表的数据，水平拆分成几张表，让每张表的数据量变小；
水平分表是为了解决单表数据量过大导致查询性能变差的问题。
2.垂直分表
将一张表的不同字段拆分到多张表，让每张表的字段数量变少；
垂直分表是为了处理表字段过多导致聚簇索引查询效率降低的问题。
一种做法是将常用的字段放到一张表中，不常用的字段放到另一张表中，减少每次查询的结果长度，这样可以充分提升热点数据的查询效率；
另外就是将大数据放到一张表，较短的数据放到一张表。这样也是为了减少每次查询的长度。
为什么要减少查询结果的长度？
1.本身数据量大需要更长的读取时间；
2.跨页，页是数据的存储单位，查找和定位操作都是以页为单位，相同大小的页，可以保存更多的行数数据库整体性能越好；
3.数据库以行为单位缓存到内存中，每行数据越小，缓存的行数越多，命中率越高，效率也就越高。
### 如何处理分页查询
全局视野法
将所有数据库中前三页的数据都查出来，统一进行排序
优点是结果精确，缺点是效率很差，且页数越高效率越差，因为要把前N页的都查出来，再进行所有数据库的排序
业务折衷-禁止跳页查询
增加一个条件，前端不支持跳页，每次只能查看下一页。
举例每页10条，取到当前页的最大id：A，去每个库中查询id>A，查10条，再将所有结果排序取10条，返回前端
优点：结果精确，效率很好，写法简单。
缺点：禁止跳页
二次查询法
两个表，分页查询，按照日期date排序，每页5条，查询第101页，偏移量为500。
首次查询，去每个表中查询前505条（偏移量+每页大小）数据，只查排序字段date，这个字段设计的时候就必须加索引，所以下面这个sql效率是非常高的。
select date from table1 order by date limit 505;
select date from table2 order by date limit 505;
从1010条结果中取第501条date，获得边界值date1;
第二次查询
select * from table1 where date >= date1 order by date limit 5;
select * from table2 where date >= date1 order by date limit 5;
将10条结果排序，取前5条，就是最终结果了。
### 分库如何扩容
停服迁移
停服，使用数据迁移工具完成迁移，修改入库规则，重启服务
从库迁移
比如有两台数据库，分别有两个从库，一共四个，其中A和A0数据一致，B和B0数据一致；
主库不变，直接修改分片规则，将原本%2=0放入A库改为%4=0放入A库，%4=2放入A0库；B库以此类推；
然后将A库中%4=2的数据清理掉，其他3个库以此类推将废弃数据清理掉，完成扩容。
最后再抽时间给每个数据库搭配一个从库。
这种方式的优点是无需停止服务进行升级和迁移。
双写迁移
倍数扩容
向老库和新库同时写入数据，同时将历史数据进行迁移；
迁移完成，修改分片规则；
最后清理废弃数据。
