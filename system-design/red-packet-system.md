# 红包系统设计
## 系统可能出现的问题及其解决方案
### 超发问题
解决方案：
- 1.原子操作：在扣减库存和金额时，使用数据库的原子操作。
- 2.乐观锁：在表中增加一个版本号字段 version。更新时带上版本号。
- 3.Redis 原子操作：将红包库存和金额信息放在Redis中，利用 DECR、HINCRBY 等原子指令进行扣减，性能极高。这是目前最主流的方案。
### 重复抢红包
解决方案：
- 1.唯一索引：在红包领取记录表上，为 (red_packet_id, user_id) 创建一个联合唯一索引。这是最根本的防重措施，从数据库层面杜绝重复。
- 2.前置检查：在“抢”的逻辑中，先查询领取记录表，判断该用户是否已领取。
- 3.幂等性Token：在用户点击红包时，客户端生成一个唯一的幂等Token（可与红包ID、用户ID关联）发送给服务端。服务端在处理请求前，先校验这个Token是否已被使用，并将其在缓存中标记为“已处理”。
### 库存和金额不一致
解决方案：
- 1.事务：将扣减红包主表库存和创建领取记录的操作放在同一个数据库事务中。
- 2.状态机：引入明确的状态字段（如 status: 0-创建，1-已领完，2-已过期），通过状态来控制流程，避免依赖数量和金额的混合判断。